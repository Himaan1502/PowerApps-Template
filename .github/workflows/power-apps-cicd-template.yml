name: Power Apps CI/CD Reusable Workflow

on:
  workflow_call:
    inputs:
      solution-name:
        required: true
        type: string
        description: 'Name of the Power Platform solution'
      environment-url:
        required: true
        type: string
        description: 'URL of the Power Platform environment'
      target-environment-url:
        required: false
        type: string
        description: 'URL of the target Power Platform environment for deployment'
      solution-output-folder:
        required: false
        type: string
        default: 'out/solutions'
        description: 'Folder path for solution output'
      solution-type:
        required: false
        type: string
        default: 'Unmanaged'
        description: 'Solution type (Managed/Unmanaged)'
      run-build:
        required: false
        type: boolean
        default: true
        description: 'Whether to build managed solution'
      run-deploy:
        required: false
        type: boolean
        default: false
        description: 'Whether to deploy to target environment'
    secrets:
      azure_client_id:
        required: true
      azure_client_secret:
        required: true
      azure_tenant_id:
        required: true

jobs:
  export-and-unpack:
    runs-on: windows-latest
    environment: development
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Who Am I (Verify Connection)
        uses: microsoft/powerplatform-actions/who-am-i@v1
        with:
          environment-url: ${{ inputs.environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}

      - name: Export Solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ inputs.environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}
          solution-name: ${{ inputs.solution-name }}
          solution-output-file: ${{ inputs.solution-output-folder }}/${{ inputs.solution-name }}.zip
          managed: false

      - name: Unpack Solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: ${{ inputs.solution-output-folder }}/${{ inputs.solution-name }}.zip
          solution-folder: ${{ inputs.solution-output-folder }}/${{ inputs.solution-name }}
          solution-type: ${{ inputs.solution-type }}
          overwrite-files: true

      - name: Branch Solution
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder: ${{ inputs.solution-output-folder }}/${{ inputs.solution-name }}
          solution-target-folder: solutions/${{ inputs.solution-name }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allow-empty-commit: true

  build-managed-solution:
    needs: export-and-unpack
    runs-on: windows-latest
    if: ${{ inputs.run-build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Pack Solution
        uses: microsoft/powerplatform-actions/pack-solution@v1
        with:
          solution-folder: solutions/${{ inputs.solution-name }}
          solution-file: out/managed/${{ inputs.solution-name }}_managed.zip
          solution-type: Managed

      - name: Upload Managed Solution as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: managed-solution
          path: out/managed/${{ inputs.solution-name }}_managed.zip

  deploy-to-target:
    needs: build-managed-solution
    runs-on: windows-latest
    if: ${{ inputs.run-deploy && inputs.target-environment-url != '' }}
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Download Managed Solution Artifact
        uses: actions/download-artifact@v3
        with:
          name: managed-solution
          path: out/managed/

      - name: Import Solution to Target
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ inputs.target-environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}
          solution-file: out/managed/${{ inputs.solution-name }}_managed.zip
          force-overwrite: true
          publish-changes: true

      - name: Publish Solution
        uses: microsoft/powerplatform-actions/publish-solution@v1
        with:
          environment-url: ${{ inputs.target-environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}
