name: Power Apps CD Reusable Workflow (Build & Deploy)

on:
  workflow_call:
    inputs:
      solution-name:
        required: true
        type: string
        description: 'Name of the Power Platform solution'
      target-environment-url:
        required: true
        type: string
        description: 'URL of the target Power Platform environment for deployment'
      target-environment:
        required: true
        type: string
        description: 'Target environment name (DEV, UAT, PROD) - used for deployment settings file'
      run-build:
        required: false
        type: boolean
        default: true
        description: 'Whether to build managed solution'
      run-deploy:
        required: false
        type: boolean
        default: true
        description: 'Whether to deploy to target environment'
    secrets:
      azure_client_id:
        required: true
      azure_client_secret:
        required: true
      azure_tenant_id:
        required: true

jobs:
  build-managed-solution:
    runs-on: windows-latest
    if: ${{ inputs.run-build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Pack Solution
        uses: microsoft/powerplatform-actions/pack-solution@v1
        with:
          solution-folder: solutions/${{ inputs.solution-name }}
          solution-file: out/managed/${{ inputs.solution-name }}_managed.zip
          solution-type: Unmanaged

      - name: Upload Managed Solution as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: managed-solution-${{ inputs.solution-name }}
          path: out/managed/${{ inputs.solution-name }}_managed.zip

  deploy-to-target:
    needs: build-managed-solution
    runs-on: windows-latest
    if: ${{ inputs.run-deploy }}
    environment: ${{ inputs.target-environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Download Managed Solution Artifact
        uses: actions/download-artifact@v4
        with:
          name: managed-solution-${{ inputs.solution-name }}
          path: out/managed/

      - name: Verify Deployment Settings File
        run: |
          $settingsFile = "settings/DeploymentSettings-${{ inputs.target-environment }}.json"
          if (Test-Path $settingsFile) {
            Write-Host "Deployment settings file found: $settingsFile"
            Write-Host "File contents:"
            Get-Content $settingsFile | Write-Host
          } else {
            Write-Host "WARNING: Deployment settings file not found: $settingsFile"
            Write-Host "Deployment will proceed without connection references and environment variables override"
          }
        shell: pwsh

      - name: Import Solution to Target with Deployment Settings
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ inputs.target-environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}
          solution-file: out/managed/${{ inputs.solution-name }}_managed.zip
          force-overwrite: true
          publish-changes: true
          use-deployment-settings-file: true
          deployment-settings-file: settings/DeploymentSettings-${{ inputs.target-environment }}.json

      - name: Publish Solution
        uses: microsoft/powerplatform-actions/publish-solution@v1
        with:
          environment-url: ${{ inputs.target-environment-url }}
          app-id: ${{ secrets.azure_client_id }}
          client-secret: ${{ secrets.azure_client_secret }}
          tenant-id: ${{ secrets.azure_tenant_id }}

      - name: Deployment Summary
        if: success()
        run: |
          Write-Host "Deployment successful!"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Environment: ${{ inputs.target-environment }}"
          Write-Host "Solution: ${{ inputs.solution-name }}"
          Write-Host "Target URL: ${{ inputs.target-environment-url }}"
          Write-Host "Settings File: settings/DeploymentSettings-${{ inputs.target-environment }}.json"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        shell: pwsh
